<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Search</title>
    <style>
        /* Simple styling for the search bar and results */
        #search-results {
            margin-top: 20px;
        }

        .user-result {
            cursor: pointer;
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 5px;
        }

        .user-result:hover {
            background-color: #f0f0f0;
        }

        #user-details {
            margin-top: 20px;
            display: none; /* Hide details by default */
        }

        .user-result.active {
            background-color: #e0e0e0; /* Highlight the active user */
        }
    </style>
</head>
<body>
    <h1>User Search</h1>
    <input type="text" id="search-bar" placeholder="Search users by name...">
    <div id="search-results"></div>
    <div id="user-details"></div>
    <iframe id="fontWidget" src="font_widget.html" style="position: fixed; bottom: 20px; right: 20px; border: none;"></iframe>

    <script>
        document.getElementById("search-bar").addEventListener("input", function() {
        const query = this.value;

        const resultsDiv = document.getElementById("search-results");

        // Clear results if the search bar is empty
        if (query.length === 0) {
            resultsDiv.innerHTML = "";  // Clear the displayed results
            document.getElementById("user-details").style.display = "none";  // Hide the user details section
            return;  // Stop further processing
        }

        // Trigger search when there's input
        fetch(`http://localhost:8081/api/v1/users/search?name=${query}`)
            .then(response => response.json())
            .then(users => {
                // Clear the current results
                resultsDiv.innerHTML = "";
                
                // Display the results
                users.forEach(user => {
                const userDiv = document.createElement("div");
                userDiv.classList.add("user-result");

                // Create an emoji based on the risk level
                const riskEmoji = user.high_risk ? "ðŸŸ¥" : "ðŸŸ©";  // Red for High Risk, Green for Low Risk

                // Create the "Check Assessment" button
                const checkButton = document.createElement("button");
                checkButton.innerText = "Check Assessment";
                checkButton.onclick = () => {
                    window.location.href = `completed_assessments.html?userid=${user.id}`;

                    // Redirect to completed assessments page
                };

                // Set the inner HTML of the user div
                userDiv.innerHTML = `${user.name} - ${riskEmoji} ${user.high_risk ? "High Risk" : "Low Risk"}`;

                // Append the "Check Assessment" button to the user div
                userDiv.appendChild(checkButton);
                    // Show user details on hover
                    userDiv.onmouseover = () => {
                        userDiv.classList.add("active");
                        displayUserDetails(user.id);  // Call to show user details
                    };

                    // Hide user details on mouse out
                    userDiv.onmouseout = () => {
                        userDiv.classList.remove("active");
                        hideUserDetails();  // Hide the user details
                    };

                    resultsDiv.appendChild(userDiv);
                });
            })
            .catch(error => console.error('Error fetching user data:', error));
    });


        function displayUserDetails(userId) {
            // Show the user details dynamically
            fetch(`http://localhost:8081/api/v1/users/user_profile/${userId}`)
                .then(response => response.json())
                .then(user => {
                    const detailsDiv = document.getElementById("user-details");
                    detailsDiv.innerHTML = `
                        <h3>User Details</h3>
                        <p><strong>Name:</strong> ${user.name}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Role:</strong> ${user.role}</p>
                        <p><strong>Facial ID:</strong> ${user.facial_id || "Not Provided"}</p>
                    `;
                    detailsDiv.style.display = "block";  // Show the details section
                })
                .catch(error => console.error('Error fetching user details:', error));
        }

        function hideUserDetails() {
            const detailsDiv = document.getElementById("user-details");
            detailsDiv.style.display = "none";  // Hide the details section
        }


        // Store the initial font sizes of all elements
        const initialFontSizes = {};

        // Function to store initial font sizes
        function storeInitialFontSizes() {
            document.querySelectorAll('h1, h2, h3, p, span, body').forEach(element => {
                initialFontSizes[element] = window.getComputedStyle(element).fontSize;
            });
        }

        // Function to apply the scale factor
        function applyScaleFactor(scaleFactor) {
            document.querySelectorAll('h1, h2, h3, p, span, body').forEach(element => {
                if (initialFontSizes[element]) {
                    const initialSize = parseFloat(initialFontSizes[element]);
                    const newSize = initialSize * scaleFactor;
                    element.style.fontSize = `${newSize}px`;
                }
            });
        }


        // Call this function on page load
        window.addEventListener('load', () => {
            storeInitialFontSizes(); // Store the initial sizes

            // Retrieve the scale factor from local storage
            const storedScaleFactor = localStorage.getItem('scaleFactor');

            if (storedScaleFactor) {
                const scaleFactor = parseFloat(storedScaleFactor);
                if (!isNaN(scaleFactor)) {
                    applyScaleFactor(scaleFactor); // Apply the stored scale factor
                } else {
                    console.error('Invalid scale factor in local storage:', storedScaleFactor);
                }
            }
        });

        // Listen for messages from the iframe
        window.addEventListener('message', (event) => {
            // Log the received message for debugging
            console.log('Message received from iframe:', event.data);

            // Ensure the message is coming from the expected origin
            if (event.origin !== window.location.origin) {
                console.error('Invalid origin:', event.origin);
                return;
            }

            const scaleFactor = parseFloat(event.data);

            // Apply the scale factor to the parent document
            if (!isNaN(scaleFactor)) {
                applyScaleFactor(scaleFactor);
            } else {
                console.error('Invalid scale factor:', event.data);
            }
        });
    </script>
</body>
</html>
